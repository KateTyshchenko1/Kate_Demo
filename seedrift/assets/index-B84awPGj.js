(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))r(c);new MutationObserver(c=>{for(const i of c)if(i.type==="childList")for(const h of i.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&r(h)}).observe(document,{childList:!0,subtree:!0});function n(c){const i={};return c.integrity&&(i.integrity=c.integrity),c.referrerPolicy&&(i.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?i.credentials="include":c.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(c){if(c.ep)return;c.ep=!0;const i=n(c);fetch(c.href,i)}})();function H(a,t,n){return Math.min(n,Math.max(t,a))}function ot(){return performance.now()}function Qt(a){const t=Math.max(0,Math.floor(a/1e3)),n=Math.floor(t/60).toString().padStart(2,"0"),r=(t%60).toString().padStart(2,"0");return`${n}:${r}`}function $t(a){const t=a.getContext("2d");let n=Math.max(1,Math.min(window.devicePixelRatio||1,3)),r=0,c=0;const i=1/60;let h=0,A=0;const u=[];let y=700;const C=new Image;let O=!1;C.onload=()=>{O=!0},C.onerror=()=>{O=!1,console.warn("seed.png not found or failed to load; using vector fallback")},C.src="/seed.png?v="+Math.random().toString(36).slice(2);const ct=[-18,-12,-8],I=[.985,.99,.993],p=[22,16,10],v=[.8,.9,1],E=[1,.85,.7],z=.002,it=260,xt=.28,rt=1.1,lt=14,dt=.002;let R=0;const Et=.08,Bt=.18,St=1500;let j=!1,G=0;const Y=120,vt=300,Rt=640;function gt(o){return 1-Math.pow(1-o,3)}function Xt(o=y){u.length=0;for(let s=0;s<o;s++){const d=Math.random()<.2?0:Math.random()<.67?1:2,l=4+Math.random()*6*(d===2?.9:1);u.push({x:Math.random()*r,y:Math.random()*c,vx:(Math.random()-.5)*8,vy:-10-Math.random()*10,theta:Math.random()*Math.PI*2,omega:(Math.random()-.5)*.6,size:l,layer:d,mass:v[d],alpha:E[d],popUntil:0})}}function Nt(o,s,d){n=d,r=Math.floor(o*n),c=Math.floor(s*n),a.width=r,a.height=c,a.style.width=`${Math.floor(r/n)}px`,a.style.height=`${Math.floor(c/n)}px`;const l=r/n,g=c/n,e=1280*720,m=l*g;y=Math.max(300,Math.min(1100,Math.round(700*(m/e)))),Xt(y)}function Zt(o){if(o&&!j){G=0;const s=r*.5,d=c*.85;for(const l of u){const g=l.x-s,e=l.y-d;g*g+e*e<Y*Y&&(l.popUntil=A+.15)}}j=o}function Ht(o){const s=H(o,0,1),d=s>R?Et:Bt,l=i/Math.max(d,.001);R+=(s-R)*l,j?G+=i:G=Math.max(0,G-i)}function Dt(o,s,d){let l=Math.imul(374761393,o)^Math.imul(668265263,s)^Math.imul(2147483647,d);return l=(l^l>>>13)*1274126177,((l^l>>>16)>>>0)/4294967295}function X(o){return o*o*(3-2*o)}function ut(o,s,d){const l=Math.floor(o),g=Math.floor(s),e=Math.floor(d),m=o-l,w=s-g,N=d-e;let W=0;for(let M=0;M<=1;M++)for(let f=0;f<=1;f++)for(let b=0;b<=1;b++){const _=(b?X(m):1-X(m))*(f?X(w):1-X(w))*(M?X(N):1-X(N));W+=Dt(l+b,g+f,e+M)*_}return W}function Tt(o,s,d){const g=(M,f)=>ut(M,f,d),e=(M,f)=>ut(M+19.1,f+7.7,d+3.1),m=(g(o+.01,s)-g(o-.01,s))/.02,w=(g(o,s+.01)-g(o,s-.01))/(2*.01),N=(e(o+.01,s)-e(o-.01,s))/(2*.01);return{x:(e(o,s+.01)-e(o,s-.01))/(2*.01)-w,y:m-N}}function Gt(){A+=i;const o=gt(H(R,0,1))*St,s=H(Y+vt*G,Y,Rt),d=r*.5,l=c*.85,g=1+.3*H(R,0,1);for(const e of u){const m=e.layer;e.vx*=I[m],e.vy*=I[m];const w=e.x/it,N=e.y/it,W=A*xt,M=Tt(w,N,W),f=e.x-d,b=e.y-l,_=f*f+b*b,mt=Math.exp(-_/(2*s*s));let It=Math.sqrt(_)+1e-6;const Ft=f/It,Kt=b/It,Ot=Ft*(o*mt)/e.mass,zt=Kt*(o*mt)/e.mass,Yt=r*.5,_t=c*.5,ht=1-gt(H(R,0,1)),Vt=(Yt-e.x)*dt*lt*ht,Ut=(_t-e.y)*dt*lt*ht;e.vx+=(M.x*p[m]*g+Ot+Vt)*i*rt,e.vy+=(ct[m]+M.y*p[m]*g+zt+Ut)*i*rt,e.x+=e.vx*i,e.y+=e.vy*i,e.omega+=z*e.vx,e.theta+=e.omega*i;const qt=Math.atan2(e.vy,e.vx);e.theta+=(qt-e.theta)*.05;const Z=20;e.x<-Z?e.x=r+Z:e.x>r+Z&&(e.x=-Z),e.y<-Z&&(e.y=c+Z,e.x=Math.random()*r,e.theta=Math.random()*Math.PI*2,e.omega=(Math.random()-.5)*.4)}}function Wt(o){for(h+=o/1e3;h>=i;)Gt(),h-=i}function Lt(o){const s=o.size;t.save(),t.translate(o.x,o.y),t.rotate(o.theta);const d=A<o.popUntil?1.1:1;if(t.globalAlpha=Math.min(1,o.alpha*d),O){const l=s*2.2,g=s*2.6;t.drawImage(C,-l/2,-g/2,l,g)}else{t.strokeStyle="rgba(30,136,229,0.45)",t.fillStyle="rgba(255,255,255,0.98)",t.lineWidth=.9,t.beginPath(),t.ellipse(0,0,s*.35,s*.5,0,0,Math.PI*2),t.fill(),t.stroke(),t.beginPath(),t.moveTo(0,s*.5),t.quadraticCurveTo(s*.2,s*.9,0,s*1.3),t.stroke();const l=20;for(let g=0;g<l;g++){const e=g/l*Math.PI*2,m=Math.cos(e)*s,w=Math.sin(e)*s;t.beginPath(),t.moveTo(0,0),t.lineTo(m,w),t.stroke()}}t.restore(),t.globalAlpha=1}function Pt(){t.clearRect(0,0,r,c);for(const o of u)Lt(o)}function kt(){t.clearRect(0,0,r,c)}return{resize:Nt,setExhaling:Zt,updateBreath:Ht,step:Wt,draw:Pt,clear:kt}}const ft=30,At=2048;async function jt(a){const t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),n=new(window.AudioContext||window.webkitAudioContext),c=t.getAudioTracks()[0]?.getSettings?.();let i=[];const h=I=>{for(const p of i)p(I)};let A=null,u=null,y=null,C=null;return{ctx:n,stream:t,start:async()=>{await n.resume(),y=n.createMediaStreamSource(t);try{if(n.audioWorklet){const p=new URL("data:text/javascript;base64,Ly8gTWluaW1hbCBBdWRpb1dvcmtsZXRQcm9jZXNzb3IgZW1pdHRpbmcgUk1TIHBlciBob3AKY2xhc3MgRXhoYWxlRGV0ZWN0b3IgZXh0ZW5kcyBBdWRpb1dvcmtsZXRQcm9jZXNzb3IgewogICAgY29uc3RydWN0b3Iob3B0aW9ucykgewogICAgICAgIHN1cGVyKCk7CiAgICAgICAgY29uc3QgeyB3aW5kb3dTaXplID0gMjA0OCB9ID0gb3B0aW9ucy5wcm9jZXNzb3JPcHRpb25zIHx8IHt9OwogICAgICAgIHRoaXMud2luZG93U2l6ZSA9IHdpbmRvd1NpemU7CiAgICAgICAgdGhpcy5idWZmZXIgPSBuZXcgRmxvYXQzMkFycmF5KHdpbmRvd1NpemUpOwogICAgICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgIH0KICAgIHByb2Nlc3MoaW5wdXRzKSB7CiAgICAgICAgY29uc3QgaW5wdXQgPSBpbnB1dHNbMF07CiAgICAgICAgaWYgKCFpbnB1dCB8fCBpbnB1dC5sZW5ndGggPT09IDApIHJldHVybiB0cnVlOwogICAgICAgIGNvbnN0IGNoMCA9IGlucHV0WzBdOwogICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY2gwLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgIHRoaXMuYnVmZmVyW3RoaXMub2Zmc2V0KytdID0gY2gwW2ldOwogICAgICAgICAgICBpZiAodGhpcy5vZmZzZXQgPj0gdGhpcy53aW5kb3dTaXplKSB7CiAgICAgICAgICAgICAgICBsZXQgc3VtID0gMDsKICAgICAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgdGhpcy53aW5kb3dTaXplOyBqKyspIHN1bSArPSB0aGlzLmJ1ZmZlcltqXSAqIHRoaXMuYnVmZmVyW2pdOwogICAgICAgICAgICAgICAgY29uc3Qgcm1zID0gTWF0aC5zcXJ0KHN1bSAvIHRoaXMud2luZG93U2l6ZSk7CiAgICAgICAgICAgICAgICB0aGlzLnBvcnQucG9zdE1lc3NhZ2UoeyB0OiBjdXJyZW50VGltZSAqIDEwMDAsIHJtcyB9KTsKICAgICAgICAgICAgICAgIHRoaXMub2Zmc2V0ID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KfQoKcmVnaXN0ZXJQcm9jZXNzb3IoJ2V4aGFsZS1kZXRlY3RvcicsIEV4aGFsZURldGVjdG9yKTsKCgo=",import.meta.url);await n.audioWorklet.addModule(p),A=new AudioWorkletNode(n,"exhale-detector",{processorOptions:{windowSize:At,hopMs:ft}}),A.port.onmessage=E=>h(E.data);const v=n.createGain();v.gain.value=0,y.connect(A).connect(v).connect(n.destination);return}}catch{}u=n.createAnalyser(),u.fftSize=At,y.connect(u);const I=new Float32Array(u.fftSize);C=window.setInterval(()=>{u.getFloatTimeDomainData(I);let p=0;for(let E=0;E<I.length;E++){const z=I[E];p+=z*z}const v=Math.sqrt(p/I.length);h({t:performance.now(),rms:v})},ft)},stop:()=>{A?.disconnect(),u?.disconnect(),y?.disconnect(),C&&(clearInterval(C),C=null),t.getTracks().forEach(I=>I.stop())},subscribe:I=>(i.push(I),()=>{i=i.filter(p=>p!==I)}),getSettings:()=>c}}const Jt=1500,te=1.2,ee=.9,oe=120,ne=180;let B="IDLE";const J=document.getElementById("idle"),tt=document.getElementById("hud"),se=document.getElementById("canvas"),Q=document.getElementById("start"),ae=document.getElementById("end"),pt=document.getElementById("exhaleDot"),ce=document.getElementById("timer");document.getElementById("tooNoisy");const Ct=document.getElementById("debrief"),ie=document.getElementById("stats"),re=document.getElementById("restart"),V=document.getElementById("debug"),S=$t(se);let nt=performance.now();function yt(){const a=performance.now(),t=a-nt;nt=a,S.step(t),S.draw(),requestAnimationFrame(yt)}function wt(){const t=document.querySelector(".topbar")?.offsetHeight??0;S.resize(window.innerWidth,window.innerHeight-t,Math.min(window.devicePixelRatio||1,3))}window.addEventListener("resize",wt);let q=null,P=0,st=0,k=0,D=0,at=0,x=0,bt=0,F=[],$=0,Mt=0,T=0,L=0,et=0,U=0;window.addEventListener("pointermove",a=>{a.clientX,a.clientY},{passive:!0});window.addEventListener("touchstart",a=>{a.touches[0]&&(a.touches[0].clientX,a.touches[0].clientY)},{passive:!0});function K(a){B=a,B==="IDLE"?(J.classList.remove("hidden"),tt.style.display="none"):B==="CALIBRATING"||B==="PAINTING"?(J.classList.add("hidden"),tt.style.display="grid"):B==="DEBRIEF"&&(J.classList.add("hidden"),tt.style.display="none")}function le(a,t,n){return a*(1-n)+t*n}function de(a){if(!("rms"in a))return;const{rms:t}=a;if(B==="CALIBRATING"){k++;const n=t-P;P+=n/k;const r=t-P;st+=n*r,V&&(V.textContent=`calib rms=${t.toFixed(4)}`)}else if(B==="PAINTING"){const n=ot(),r=Math.max(15,Math.min(60,et?a.t-et:30));et=a.t;const c=t>D,i=t<D*ee;if(c?T+=r:T=0,i?L+=r:L=0,U>0&&(T=0,U=Math.max(0,U-r)),x===0&&T>=oe&&(x=n,at++,S.setExhaling(!0),pt.setAttribute("style","opacity:1")),x!==0&&L>=ne){const u=(n-x)/1e3;F.push(u),x=0,S.setExhaling(!1),pt.setAttribute("style","opacity:0.25"),T=0,L=0,U=220}if(x!==0){const u=Math.abs(t-Mt);$=le($,u,.2)}Mt=t,V&&(V.textContent=`rms=${t.toFixed(4)} thr=${D.toFixed(4)} exhaling=${x!==0}`);const h=H((t-D)/Math.max(D,1e-6),0,1);S.updateBreath(h);const A=ot()-bt;ce.textContent=Qt(A)}}async function ge(){Q.disabled=!0,wt(),K("CALIBRATING");try{q=await jt()}catch{Q.disabled=!1,alert("Microphone permission is required. Falling back to Press & Hold mode in a future version.");return}q.subscribe(de),await q.start(),P=0,st=0,k=0,await new Promise(n=>setTimeout(n,Jt));const a=k>1?st/(k-1):1e-6,t=Math.sqrt(a);D=Math.max(.001,P+te*t),K("PAINTING"),bt=ot(),at=0,F=[],$=0,x=0,T=0,L=0,nt=performance.now(),requestAnimationFrame(yt)}function ue(){const a=F.length?F.reduce((n,r)=>n+r,0)/F.length:0,t=1/($+.001);ie.textContent=`Breaths: ${at} • Avg exhale: ${a.toFixed(1)} s • Smoothness: ${t.toFixed(2)}`,K("DEBRIEF"),Ct.showModal(),q?.stop()}function me(){Ct.close(),S.clear(),K("IDLE"),Q.disabled=!1}Q.addEventListener("click",ge);ae.addEventListener("click",ue);re.addEventListener("click",me);K("IDLE");
